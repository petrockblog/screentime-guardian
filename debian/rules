#!/usr/bin/make -f

export DH_VERBOSE = 1
export CGO_ENABLED = 0

VERSION := $(shell git describe --tags --always 2>/dev/null || echo "1.0.0")
BUILD_TIME := $(shell date -u +"%Y-%m-%dT%H:%M:%SZ")
LDFLAGS := -X main.Version=$(VERSION) -X main.BuildTime=$(BUILD_TIME)

%:
	dh $@ --with systemd

override_dh_auto_build:
	GOOS=linux go build -ldflags "$(LDFLAGS)" -o screentime-guardian ./cmd/daemon

override_dh_auto_install:
	install -D -m 0755 screentime-guardian debian/screentime-guardian/usr/local/bin/screentime-guardian
	install -D -m 0644 systemd/screentime-guardian.service debian/screentime-guardian/lib/systemd/system/screentime-guardian.service
	install -D -m 0600 configs/config.yaml.example debian/screentime-guardian/usr/share/doc/screentime-guardian/examples/config.yaml

override_dh_auto_test:
	# Skip tests during package build
